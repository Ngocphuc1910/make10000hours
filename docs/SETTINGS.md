# User Settings Implementation

## Overview

This document describes how user settings are implemented in the Make10000Hours application.

## Database Structure

We store user settings in the `user_settings` table in Supabase. The table schema can be found in `supabase/migrations/20240317_user_settings_table.sql`. The table has the following structure:

```sql
CREATE TABLE IF NOT EXISTS user_settings (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  settings JSONB NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
  UNIQUE(user_id)
);
```

Key points:
- Each user has a single row in the table (enforced by the UNIQUE constraint)
- All settings are stored in a single JSONB column called `settings`
- This approach allows us to add new settings without requiring database schema changes

## SQL Files Organization

The SQL files are organized in the following structure:
- `supabase/migrations/` - Contains database schema changes and table creation scripts
- `supabase/functions/` - Contains utility functions for managing user settings

## Adding New Settings

When adding new settings to the application:

1. Update the type definition in `src/types/settings.js`
2. Update the defaultSettings object in the same file
3. Add the necessary UI elements to `src/components/SettingsModal.js`

No database schema changes are needed because we use a JSONB column.

## Synchronization

Settings are synchronized as follows:

1. For logged-in users:
   - Settings are loaded from the database when the app loads
   - Settings are saved to both localStorage and the database when changed
   - When a user logs in on a new device, their settings are automatically loaded from the database

2. For anonymous users:
   - Settings are stored in localStorage only
   - When a user logs in, their localStorage settings are saved to the database if they don't have any settings there already

## Row Level Security

The `user_settings` table has Row Level Security (RLS) policies that ensure:

1. Users can only read their own settings
2. Users can only update their own settings
3. Users can only delete their own settings

This protects user data from unauthorized access. 