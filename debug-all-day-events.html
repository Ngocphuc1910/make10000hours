<!DOCTYPE html>
<html>
<head>
    <title>Debug All-Day Events in Week View</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .event { margin: 5px 0; padding: 5px; background: #f0f0f0; }
        .all-day { background: #e3f2fd; }
        .not-all-day { background: #fff3e0; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; }
    </style>
</head>
<body>
    <h1>Debug All-Day Events in Week View</h1>
    <div id="output"></div>

    <script>
        // Mock the data structures we need
        const mockEvents = [
            {
                id: '1',
                title: 'All Day Task 1',
                start: new Date('2025-01-13T00:00:00'),
                end: new Date('2025-01-13T23:59:59'),
                isAllDay: true,
                isTask: true,
                color: '#EF4444'
            },
            {
                id: '2',
                title: 'All Day Task 2',
                start: new Date('2025-01-14T00:00:00'),
                end: new Date('2025-01-14T23:59:59'),
                isAllDay: true,
                isTask: true,
                color: '#10B981'
            },
            {
                id: '3',
                title: 'Timed Task',
                start: new Date('2025-01-13T10:00:00'),
                end: new Date('2025-01-13T11:00:00'),
                isAllDay: false,
                isTask: true,
                color: '#3B82F6'
            },
            {
                id: '4',
                title: 'Multi Day All Day Task',
                start: new Date('2025-01-15T00:00:00'),
                end: new Date('2025-01-16T23:59:59'),
                isAllDay: true,
                isTask: true,
                isMultiDay: true,
                displayStart: new Date('2025-01-15T00:00:00'),
                displayEnd: new Date('2025-01-16T23:59:59'),
                daySpan: 2,
                color: '#8B5CF6'
            }
        ];

        // Mock feature flag
        const isMultiDayEnabled = () => true;

        // Mock date utilities
        const isSameDay = (date1, date2) => {
            return date1.toDateString() === date2.toDateString();
        };

        const startOfDay = (date) => {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            return d;
        };

        const endOfDay = (date) => {
            const d = new Date(date);
            d.setHours(23, 59, 59, 999);
            return d;
        };

        const addDays = (date, days) => {
            const d = new Date(date);
            d.setDate(d.getDate() + days);
            return d;
        };

        // Mock getEventsForDay function from utils
        const getEventsForDay = (events, day, allDayOnly = false) => {
            const dayStart = startOfDay(day);
            const dayEnd = endOfDay(day);
            
            return events.filter(event => {
                if (allDayOnly && !event.isAllDay) return false;
                
                // For multi-day events, check if the day falls within the event's date range
                if (event.isMultiDay && event.displayStart && event.displayEnd) {
                    const eventStart = startOfDay(event.displayStart);
                    const eventEnd = endOfDay(event.displayEnd);
                    return day >= eventStart && day <= eventEnd;
                }
                
                // For single-day events, check if they occur on this day
                const eventStart = startOfDay(event.start);
                const eventEnd = endOfDay(event.end);
                return (event.start >= dayStart && event.start <= dayEnd) ||
                       (event.end >= dayStart && event.end <= dayEnd) ||
                       (event.start <= dayStart && event.end >= dayEnd);
            });
        };

        // Mock getAllDayEvents function from ScrollableWeekView
        const getAllDayEvents = (date) => {
            if (isMultiDayEnabled()) {
                return getEventsForDay(mockEvents, date, true); // Only all-day events
            } else {
                return mockEvents.filter(event => 
                    isSameDay(event.start, date) && event.isAllDay
                );
            }
        };

        // Mock calculateMultiDayEventPositions
        const calculateMultiDayEventPositions = (events, weekStart, weekEnd) => {
            // Filter to only multi-day events that intersect with this week
            const multiDayEvents = events.filter(event => {
                if (!event.isMultiDay || !event.displayStart || !event.displayEnd) return false;
                
                const eventStart = startOfDay(event.displayStart);
                const eventEnd = endOfDay(event.displayEnd);
                const weekStartDay = startOfDay(weekStart);
                const weekEndDay = endOfDay(weekEnd);
                
                return eventStart <= weekEndDay && eventEnd >= weekStartDay;
            });
            
            const positionedEvents = multiDayEvents.map((event, index) => ({
                event,
                position: { row: index, left: 0, width: event.daySpan || 1 }
            }));
            
            return {
                events: positionedEvents,
                maxRow: multiDayEvents.length - 1
            };
        };

        // Test the week view logic
        const weekStart = new Date('2025-01-13T00:00:00'); // Monday
        const weekEnd = new Date('2025-01-19T23:59:59');   // Sunday

        const allDays = [];
        for (let i = 0; i < 7; i++) {
            allDays.push(addDays(weekStart, i));
        }

        let output = '<div class="debug-section">';
        output += '<h2>Test Configuration</h2>';
        output += `<p><strong>Week Start:</strong> ${weekStart.toDateString()}</p>`;
        output += `<p><strong>Week End:</strong> ${weekEnd.toDateString()}</p>`;
        output += `<p><strong>Multi-day Feature Enabled:</strong> ${isMultiDayEnabled()}</p>`;
        output += '</div>';

        output += '<div class="debug-section">';
        output += '<h2>Mock Events</h2>';
        mockEvents.forEach(event => {
            output += `<div class="event ${event.isAllDay ? 'all-day' : 'not-all-day'}">`;
            output += `<strong>${event.title}</strong><br>`;
            output += `Start: ${event.start.toISOString()}<br>`;
            output += `End: ${event.end.toISOString()}<br>`;
            output += `All Day: ${event.isAllDay}<br>`;
            output += `Multi Day: ${event.isMultiDay || false}<br>`;
            if (event.displayStart) output += `Display Start: ${event.displayStart.toISOString()}<br>`;
            if (event.displayEnd) output += `Display End: ${event.displayEnd.toISOString()}<br>`;
            output += '</div>';
        });
        output += '</div>';

        // Test multiDayEventPositions calculation
        output += '<div class="debug-section">';
        output += '<h2>Multi-Day Event Positions Calculation</h2>';
        
        // Get all all-day events that intersect with this time range
        const allDayEvents = mockEvents.filter(event => {
            if (!event.isAllDay) return false;
            
            const eventStart = new Date(event.displayStart || event.start);
            const eventEnd = new Date(event.displayEnd || event.end);
            
            // Check if event intersects with the time range
            return eventStart <= weekEnd && eventEnd >= weekStart;
        });
        
        output += `<p><strong>All-day events found:</strong> ${allDayEvents.length}</p>`;
        allDayEvents.forEach(event => {
            output += `<div class="event all-day">`;
            output += `${event.title} (${event.isMultiDay ? 'Multi-day' : 'Single-day'})`;
            output += `</div>`;
        });
        
        const multiDayEventPositions = calculateMultiDayEventPositions(allDayEvents, weekStart, weekEnd);
        output += `<p><strong>Positioned events:</strong> ${multiDayEventPositions.events.length}</p>`;
        output += `<p><strong>Max row:</strong> ${multiDayEventPositions.maxRow}</p>`;
        output += '</div>';

        // Test getAllDayEvents for each day
        output += '<div class="debug-section">';
        output += '<h2>getAllDayEvents() for Each Day</h2>';
        allDays.forEach((day, index) => {
            const dayEvents = getAllDayEvents(day);
            output += `<div class="debug-section">`;
            output += `<h3>Day ${index + 1}: ${day.toDateString()}</h3>`;
            output += `<p><strong>Events found:</strong> ${dayEvents.length}</p>`;
            dayEvents.forEach(event => {
                output += `<div class="event all-day">`;
                output += `${event.title}`;
                output += `</div>`;
            });
            output += '</div>';
        });
        output += '</div>';

        // Test the multi-day rendering logic similar to ScrollableWeekView
        output += '<div class="debug-section">';
        output += '<h2>Multi-Day Rendering Logic Test</h2>';
        allDays.forEach((day, dayIndex) => {
            output += `<div class="debug-section">`;
            output += `<h3>Day ${dayIndex + 1}: ${day.toDateString()}</h3>`;
            
            if (isMultiDayEnabled() && multiDayEventPositions) {
                const eventsForDay = multiDayEventPositions.events.filter(posEvent => {
                    // Only show events that appear on this specific day
                    const eventStart = new Date(posEvent.event.displayStart || posEvent.event.start);
                    const eventEnd = new Date(posEvent.event.displayEnd || posEvent.event.end);
                    
                    // Create day boundaries for proper comparison
                    const dayStart = new Date(day);
                    dayStart.setHours(0, 0, 0, 0);
                    const dayEnd = new Date(day);
                    dayEnd.setHours(23, 59, 59, 999);
                    
                    // Fix date comparison logic - check if event intersects with this day
                    return dayStart <= eventEnd && dayEnd >= eventStart;
                });
                
                output += `<p><strong>Multi-day events for this day:</strong> ${eventsForDay.length}</p>`;
                eventsForDay.forEach(posEvent => {
                    output += `<div class="event all-day">`;
                    output += `${posEvent.event.title} (Row: ${posEvent.position.row}, Left: ${posEvent.position.left}, Width: ${posEvent.position.width})`;
                    output += `</div>`;
                });
            } else {
                output += `<p><strong>Multi-day disabled or no positions calculated</strong></p>`;
            }
            output += '</div>';
        });
        output += '</div>';

        document.getElementById('output').innerHTML = output;
    </script>
</body>
</html>