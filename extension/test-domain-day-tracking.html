<!DOCTYPE html>
<html>
<head>
    <title>Domain-Day Tracking Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        button { margin: 5px; padding: 10px; }
        #output { white-space: pre-wrap; background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>Ultra-Simple Domain-Day Tracking Test Suite</h1>
    
    <div class="test-section">
        <h3>1. Basic Extension Health Check</h3>
        <button onclick="testExtensionHealth()">Test Extension Health</button>
        <div id="health-result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. Domain Session Update Test</h3>
        <button onclick="testDomainSession()">Test Domain Session Update</button>
        <div id="session-result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. Tab Switching Simulation</h3>
        <button onclick="simulateTabSwitch()">Simulate Tab Switch</button>
        <div id="tab-result"></div>
    </div>
    
    <div class="test-section">
        <h3>4. Sleep Detection Test</h3>
        <button onclick="testSleepDetection()">Test Sleep Detection (5min gap)</button>
        <div id="sleep-result"></div>
    </div>
    
    <div class="test-section">
        <h3>5. Cross-Day Boundary Test</h3>
        <button onclick="testCrossDayBoundary()">Test Cross-Day Boundary</button>
        <div id="boundary-result"></div>
    </div>
    
    <div class="test-section">
        <h3>6. Firebase Data Schema Compatibility</h3>
        <button onclick="testFirebaseCompatibility()">Test Firebase Schema</button>
        <div id="firebase-result"></div>
    </div>
    
    <div class="test-section">
        <h3>7. Current Stats Display</h3>
        <button onclick="getCurrentStats()">Get Current Stats</button>
        <div id="stats-result"></div>
    </div>
    
    <div class="test-section">
        <h3>Real-time Output Log</h3>
        <div id="output"></div>
        <button onclick="clearOutput()">Clear Log</button>
    </div>

    <script>
        let testCount = 0;
        
        function log(message) {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function showResult(elementId, success, message) {
            const element = document.getElementById(elementId);
            element.className = `test-result ${success ? 'success' : 'error'}`;
            element.textContent = message;
        }
        
        async function testExtensionHealth() {
            log('Testing extension health...');
            try {
                const response = await chrome.runtime.sendMessage({ type: 'EXTENSION_HEALTH_CHECK' });
                log(`Health check response: ${JSON.stringify(response)}`);
                
                if (response.status === 'ok') {
                    showResult('health-result', true, `✅ Extension healthy - Initialized: ${response.initialized}`);
                } else {
                    showResult('health-result', false, '❌ Extension not responding properly');
                }
            } catch (error) {
                log(`Health check error: ${error.message}`);
                showResult('health-result', false, `❌ Error: ${error.message}`);
            }
        }
        
        async function testDomainSession() {
            log('Testing domain session update...');
            try {
                // Simulate being on example.com
                const domain = 'example.com';
                const response = await chrome.runtime.sendMessage({ 
                    type: 'UPDATE_DOMAIN_SESSION',
                    payload: { domain, incrementalSeconds: 30, isNewVisit: true }
                });
                
                log(`Domain session response: ${JSON.stringify(response)}`);
                
                if (response.success) {
                    showResult('session-result', true, '✅ Domain session updated successfully');
                } else {
                    showResult('session-result', false, `❌ Domain session failed: ${response.error}`);
                }
            } catch (error) {
                log(`Domain session error: ${error.message}`);
                showResult('session-result', false, `❌ Error: ${error.message}`);
            }
        }
        
        async function simulateTabSwitch() {
            log('Simulating tab switch...');
            try {
                // Simulate switching from example.com to google.com
                await chrome.runtime.sendMessage({ 
                    type: 'TAB_SWITCH',
                    payload: { fromDomain: 'example.com', toDomain: 'google.com' }
                });
                
                log('Tab switch simulation sent');
                showResult('tab-result', true, '✅ Tab switch simulation completed');
                
                // Get updated stats
                setTimeout(getCurrentStats, 1000);
            } catch (error) {
                log(`Tab switch error: ${error.message}`);
                showResult('tab-result', false, `❌ Error: ${error.message}`);
            }
        }
        
        async function testSleepDetection() {
            log('Testing sleep detection...');
            try {
                // This test would require mocking the heartbeat timing
                const response = await chrome.runtime.sendMessage({ 
                    type: 'TEST_SLEEP_DETECTION',
                    payload: { simulateGap: 300000 } // 5 minutes
                });
                
                log(`Sleep detection response: ${JSON.stringify(response)}`);
                showResult('sleep-result', true, '✅ Sleep detection test completed');
            } catch (error) {
                log(`Sleep detection error: ${error.message}`);
                showResult('sleep-result', false, `❌ Error: ${error.message}`);
            }
        }
        
        async function testCrossDayBoundary() {
            log('Testing cross-day boundary...');
            try {
                const response = await chrome.runtime.sendMessage({ 
                    type: 'TEST_CROSS_DAY_BOUNDARY'
                });
                
                log(`Cross-day boundary response: ${JSON.stringify(response)}`);
                showResult('boundary-result', true, '✅ Cross-day boundary test completed');
            } catch (error) {
                log(`Cross-day boundary error: ${error.message}`);
                showResult('boundary-result', false, `❌ Error: ${error.message}`);
            }
        }
        
        async function testFirebaseCompatibility() {
            log('Testing Firebase schema compatibility...');
            try {
                const response = await chrome.runtime.sendMessage({ type: 'GET_STATS' });
                
                if (response.success) {
                    const data = response.data;
                    log(`Current stats: ${JSON.stringify(data, null, 2)}`);
                    
                    // Check schema compatibility
                    const hasRequiredFields = data.totalTime !== undefined && 
                                            data.sitesVisited !== undefined &&
                                            data.sites !== undefined;
                    
                    if (hasRequiredFields) {
                        showResult('firebase-result', true, '✅ Firebase schema compatible');
                    } else {
                        showResult('firebase-result', false, '❌ Firebase schema missing required fields');
                    }
                } else {
                    showResult('firebase-result', false, `❌ Failed to get stats: ${response.error}`);
                }
            } catch (error) {
                log(`Firebase compatibility error: ${error.message}`);
                showResult('firebase-result', false, `❌ Error: ${error.message}`);
            }
        }
        
        async function getCurrentStats() {
            log('Getting current stats...');
            try {
                const response = await chrome.runtime.sendMessage({ type: 'GET_STATS' });
                
                if (response.success) {
                    const data = response.data;
                    const statsHtml = `
                        <strong>Total Time:</strong> ${data.totalTime}s<br>
                        <strong>Sites Visited:</strong> ${data.sitesVisited}<br>
                        <strong>Sites:</strong><br>
                        ${Object.entries(data.sites || {}).map(([domain, stats]) => 
                            `&nbsp;&nbsp;${domain}: ${stats.time}s (${stats.visits} visits)`
                        ).join('<br>')}
                    `;
                    
                    showResult('stats-result', true, statsHtml);
                    log(`Stats retrieved: ${JSON.stringify(data, null, 2)}`);
                } else {
                    showResult('stats-result', false, `❌ Failed to get stats: ${response.error}`);
                }
            } catch (error) {
                log(`Get stats error: ${error.message}`);
                showResult('stats-result', false, `❌ Error: ${error.message}`);
            }
        }
        
        function clearOutput() {
            document.getElementById('output').textContent = '';
        }
        
        // Auto-run health check on load
        window.addEventListener('load', () => {
            log('Test page loaded - running initial health check...');
            setTimeout(testExtensionHealth, 500);
        });
        
        // Set up periodic stats updates
        setInterval(() => {
            if (testCount++ % 4 === 0) { // Every 20 seconds
                getCurrentStats();
            }
        }, 5000);
    </script>
</body>
</html>