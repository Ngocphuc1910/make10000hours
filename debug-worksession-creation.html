<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Session Creation Debug</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .debug-section {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #4CAF50;
        }
        .error-section {
            background: #3d1a1a;
            border-left: 4px solid #f44336;
        }
        .warning-section {
            background: #3d3d1a;
            border-left: 4px solid #ff9800;
        }
        .info-section {
            background: #1a2d3d;
            border-left: 4px solid #2196F3;
        }
        .log-entry {
            background: #1e1e1e;
            border: 1px solid #404040;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .timestamp {
            color: #888;
            font-size: 11px;
        }
        .error { color: #ff6b6b; }
        .warning { color: #feca57; }
        .info { color: #74b9ff; }
        .success { color: #00b894; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        .clear-btn { background: #f44336; }
        .clear-btn:hover { background: #da190b; }
        #logContainer {
            max-height: 400px;
            overflow-y: auto;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 10px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-active { background: #00b894; }
        .status-error { background: #ff6b6b; }
        .status-warning { background: #feca57; }
    </style>
</head>
<body>
    <h1>üîç Work Session Creation Debug Monitor</h1>
    
    <div class="debug-section info-section">
        <h2><span class="status-indicator status-active"></span>Debug Monitor Status</h2>
        <p><strong>Monitor Active:</strong> <span id="monitorStatus">Starting...</span></p>
        <p><strong>Session ID:</strong> <span id="sessionId"></span></p>
        <p><strong>Started:</strong> <span id="startTime"></span></p>
        
        <button onclick="startDebugCapture()">Start Fresh Capture</button>
        <button onclick="simulateWorkSession()">Simulate Work Session</button>
        <button onclick="checkSystemHealth()">System Health Check</button>
        <button class="clear-btn" onclick="clearLogs()">Clear Logs</button>
    </div>

    <div class="debug-section">
        <h2>üéØ Timezone Configuration</h2>
        <div id="timezoneInfo"></div>
    </div>

    <div class="debug-section">
        <h2>üìä Real-time Console Capture</h2>
        <p>All console logs, errors, and work session operations will appear below:</p>
        <div id="logContainer"></div>
    </div>

    <div class="debug-section warning-section">
        <h2>‚ö†Ô∏è Known Issues to Watch For</h2>
        <ul>
            <li><strong>UTC Transition Service:</strong> Firebase Timestamp conversion errors</li>
            <li><strong>Circuit Breaker:</strong> Emergency disable activation</li>
            <li><strong>Date Formatting:</strong> Timezone mismatch in work session storage</li>
            <li><strong>Feature Flags:</strong> UTC system disabled due to errors</li>
            <li><strong>Monitoring Service:</strong> Error threshold exceeded</li>
        </ul>
    </div>

    <div class="debug-section error-section">
        <h2>üö® Error Analysis</h2>
        <div id="errorAnalysis"></div>
    </div>

    <script>
        let logs = [];
        let debugSession = {
            id: Date.now().toString(),
            startTime: new Date(),
            errorCount: 0,
            warningCount: 0,
            workSessionAttempts: 0
        };

        // Initialize
        document.getElementById('sessionId').textContent = debugSession.id;
        document.getElementById('startTime').textContent = debugSession.startTime.toLocaleString();
        
        // Capture original console methods
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };

        function addLog(level, message, data = null) {
            const timestamp = new Date().toISOString();
            const logEntry = {
                timestamp,
                level,
                message,
                data: data ? JSON.stringify(data, null, 2) : null,
                id: Date.now() + Math.random()
            };
            
            logs.push(logEntry);
            displayLog(logEntry);
            
            // Update counters
            if (level === 'error') debugSession.errorCount++;
            if (level === 'warn') debugSession.warningCount++;
            
            // Analyze for work session issues
            analyzeLogForIssues(logEntry);
        }

        function displayLog(logEntry) {
            const container = document.getElementById('logContainer');
            const logDiv = document.createElement('div');
            logDiv.className = `log-entry ${logEntry.level}`;
            
            logDiv.innerHTML = `
                <div class="timestamp">[${logEntry.timestamp}] ${logEntry.level.toUpperCase()}</div>
                <div>${logEntry.message}</div>
                ${logEntry.data ? `<div style="margin-top: 5px; color: #888;">${logEntry.data}</div>` : ''}
            `;
            
            container.appendChild(logDiv);
            container.scrollTop = container.scrollHeight;
        }

        function analyzeLogForIssues(logEntry) {
            const issues = [];
            const message = logEntry.message.toLowerCase();
            
            // Check for specific work session issues
            if (message.includes('firebase timestamp') || message.includes('todate is not a function')) {
                issues.push('üî• Firebase Timestamp conversion error detected');
            }
            
            if (message.includes('circuit breaker') || message.includes('emergency disable')) {
                issues.push('üö´ Circuit breaker activation detected');
            }
            
            if (message.includes('utc') && message.includes('error')) {
                issues.push('üïê UTC system error detected');
            }
            
            if (message.includes('worksession') || message.includes('work session')) {
                debugSession.workSessionAttempts++;
                issues.push(`üìù Work session operation #${debugSession.workSessionAttempts}`);
            }
            
            if (message.includes('timezone') && logEntry.level === 'error') {
                issues.push('üåç Timezone handling error');
            }
            
            if (issues.length > 0) {
                updateErrorAnalysis(issues, logEntry);
            }
        }

        function updateErrorAnalysis(issues, logEntry) {
            const analysisDiv = document.getElementById('errorAnalysis');
            const issueDiv = document.createElement('div');
            issueDiv.innerHTML = `
                <div style="background: #2d1f1f; border: 1px solid #5d2d2d; border-radius: 4px; padding: 10px; margin: 5px 0;">
                    <div style="color: #ff6b6b; font-weight: bold;">${new Date().toLocaleTimeString()}</div>
                    ${issues.map(issue => `<div>‚Ä¢ ${issue}</div>`).join('')}
                    <div style="margin-top: 5px; font-size: 11px; color: #888;">Original: ${logEntry.message}</div>
                </div>
            `;
            analysisDiv.appendChild(issueDiv);
        }

        // Override console methods to capture everything
        console.log = function(...args) {
            originalConsole.log.apply(console, args);
            addLog('info', args.join(' '));
        };

        console.error = function(...args) {
            originalConsole.error.apply(console, args);
            addLog('error', args.join(' '));
        };

        console.warn = function(...args) {
            originalConsole.warn.apply(console, args);
            addLog('warning', args.join(' '));
        };

        console.info = function(...args) {
            originalConsole.info.apply(console, args);
            addLog('info', args.join(' '));
        };

        // Capture global errors
        window.addEventListener('error', function(event) {
            addLog('error', `Global Error: ${event.message}`, {
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error ? event.error.stack : null
            });
        });

        // Capture unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            addLog('error', `Unhandled Promise Rejection: ${event.reason}`, {
                promise: event.promise,
                reason: event.reason
            });
        });

        // Functions
        function startDebugCapture() {
            logs = [];
            debugSession = {
                id: Date.now().toString(),
                startTime: new Date(),
                errorCount: 0,
                warningCount: 0,
                workSessionAttempts: 0
            };
            
            document.getElementById('sessionId').textContent = debugSession.id;
            document.getElementById('startTime').textContent = debugSession.startTime.toLocaleString();
            document.getElementById('logContainer').innerHTML = '';
            document.getElementById('errorAnalysis').innerHTML = '';
            document.getElementById('monitorStatus').textContent = 'Active - Capturing...';
            
            addLog('success', 'üöÄ Debug capture started - Ready to monitor work session creation');
        }

        function simulateWorkSession() {
            addLog('info', 'üéØ Simulating work session creation...');
            
            // Mock the work session creation flow
            const mockSession = {
                userId: 'debug-user',
                taskId: 'debug-task',
                duration: 1500, // 25 minutes
                startTime: new Date(),
                endTime: new Date(Date.now() + 1500000)
            };
            
            addLog('info', 'Mock work session data prepared', mockSession);
            
            // Simulate potential issues
            setTimeout(() => {
                addLog('warning', 'Simulated UTC conversion warning - checking timezone handling');
                setTimeout(() => {
                    addLog('success', '‚úÖ Mock work session creation completed successfully');
                }, 500);
            }, 1000);
        }

        function checkSystemHealth() {
            addLog('info', 'üè• Running system health check...');
            
            const healthData = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                localStorage: {
                    available: typeof(Storage) !== "undefined",
                    itemCount: localStorage.length
                },
                sessionStorage: {
                    available: typeof(Storage) !== "undefined",
                    itemCount: sessionStorage.length
                },
                debugSession: debugSession
            };
            
            addLog('info', 'System health data collected', healthData);
            
            // Check for potential issues
            if (debugSession.errorCount > 5) {
                addLog('error', `‚ö†Ô∏è High error count detected: ${debugSession.errorCount} errors`);
            }
            
            if (debugSession.workSessionAttempts === 0) {
                addLog('warning', 'üìù No work session attempts detected yet');
            }
            
            addLog('success', '‚úÖ System health check completed');
        }

        function clearLogs() {
            logs = [];
            document.getElementById('logContainer').innerHTML = '';
            document.getElementById('errorAnalysis').innerHTML = '';
            addLog('info', 'üßπ Logs cleared - Monitor ready');
        }

        function updateTimezoneInfo() {
            const userTimezone = 'America/Los_Angeles'; // Mock user setting
            const physicalTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const now = new Date();
            
            const info = `
                <div style="background: #1e1e1e; padding: 10px; border-radius: 4px; margin: 10px 0;">
                    <div><strong>Physical Timezone:</strong> ${physicalTZ}</div>
                    <div><strong>User Setting:</strong> ${userTimezone}</div>
                    <div><strong>Physical Time:</strong> ${now.toLocaleString('en-US', { timeZone: physicalTZ })}</div>
                    <div><strong>User TZ Time:</strong> ${now.toLocaleString('en-US', { timeZone: userTimezone })}</div>
                    <div><strong>UTC Time:</strong> ${now.toISOString()}</div>
                </div>
            `;
            document.getElementById('timezoneInfo').innerHTML = info;
        }

        // Initialize timezone info
        updateTimezoneInfo();
        setInterval(updateTimezoneInfo, 5000); // Update every 5 seconds

        // Update monitor status
        setInterval(() => {
            document.getElementById('monitorStatus').textContent = `Active - ${logs.length} logs captured`;
        }, 1000);

        // Start initial capture
        startDebugCapture();
        
        addLog('success', 'üîç Work Session Debug Monitor initialized and ready');
        addLog('info', 'üìã Instructions: Create a work session in the main app and watch for errors here');
    </script>
</body>
</html>