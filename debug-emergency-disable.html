<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Emergency Disable</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 700px; margin: 20px auto; padding: 20px; }
        .urgent { background: #ff4444; color: white; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .success { background: #4caf50; color: white; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .info { background: #2196f3; color: white; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .warning { background: #ffc107; color: black; padding: 20px; border-radius: 8px; margin: 20px 0; }
        button { padding: 12px 24px; font-size: 16px; cursor: pointer; margin: 10px 5px; border: none; border-radius: 4px; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-primary { background: #007bff; color: white; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
    </style>
</head>
<body>
    <h1>üö® Emergency Disable Debug Tool</h1>
    
    <div class="urgent">
        <h3>üîç Issue Detected</h3>
        <p><strong>Problem:</strong> <code>isEmergencyDisabled: true</code> is still blocking UTC sessions</p>
        <p><strong>Evidence:</strong> Sessions are being created via legacy system despite fixes</p>
    </div>

    <div class="status-grid">
        <div id="current-status" class="info">
            <h4>üìä Current Status</h4>
            <div id="status-details">Checking...</div>
        </div>
        <div id="storage-analysis" class="info">
            <h4>üóÑÔ∏è Storage Analysis</h4>
            <div id="storage-details">Scanning...</div>
        </div>
    </div>

    <div class="info">
        <h3>üîß Actions</h3>
        <button class="btn-danger" onclick="nuclearReset()">‚ò¢Ô∏è Nuclear Reset (Clear Everything)</button>
        <button class="btn-primary" onclick="deepScan()">üîç Deep Storage Scan</button>
        <button class="btn-success" onclick="verifyFix()">‚úÖ Verify Fix</button>
    </div>

    <div id="results-area"></div>

    <div class="info">
        <h3>üéØ Console Commands</h3>
        <p>Run these in the browser console at <strong>localhost:3004</strong>:</p>
        <pre id="console-commands">// Emergency disable nuclear option
Object.keys(localStorage).forEach(key => {
    if (key.includes('emergency') || key.includes('disable') || key.includes('utc')) {
        console.log('Removing:', key, '=', localStorage.getItem(key));
        localStorage.removeItem(key);
    }
});

Object.keys(sessionStorage).forEach(key => {
    if (key.includes('emergency') || key.includes('disable') || key.includes('utc')) {
        console.log('Removing:', key, '=', sessionStorage.getItem(key));
        sessionStorage.removeItem(key);
    }
});

// Force reset everything
localStorage.clear();
sessionStorage.clear();

// Reload
window.location.reload();</pre>
        <button class="btn-primary" onclick="copyCommands()">üìã Copy Commands</button>
    </div>

    <script>
        function addResult(title, content, type = 'info') {
            const resultsArea = document.getElementById('results-area');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<h4>${title}</h4>${content}`;
            resultsArea.appendChild(div);
        }

        function updateStatus() {
            // Check localStorage emergency disable
            const emergencyDisable = localStorage.getItem('utc-emergency-disable');
            const emergencyCount = sessionStorage.getItem('utc-emergency-disable-count');
            const monitoringDisable = sessionStorage.getItem('monitoring-emergency-disable');

            document.getElementById('status-details').innerHTML = `
                <p><strong>Emergency Disable:</strong> ${emergencyDisable || 'null'}</p>
                <p><strong>Emergency Count:</strong> ${emergencyCount || 'null'}</p>
                <p><strong>Monitoring Disable:</strong> ${monitoringDisable || 'null'}</p>
                <p><strong>Status:</strong> ${emergencyDisable === 'true' ? 'üö® BLOCKING' : '‚úÖ Clear'}</p>
            `;

            // Scan all storage for emergency-related keys
            const emergencyKeys = [];
            
            Object.keys(localStorage).forEach(key => {
                if (key.includes('emergency') || key.includes('disable') || key.includes('circuit')) {
                    emergencyKeys.push(`localStorage.${key} = ${localStorage.getItem(key)}`);
                }
            });

            Object.keys(sessionStorage).forEach(key => {
                if (key.includes('emergency') || key.includes('disable') || key.includes('circuit')) {
                    emergencyKeys.push(`sessionStorage.${key} = ${sessionStorage.getItem(key)}`);
                }
            });

            document.getElementById('storage-details').innerHTML = emergencyKeys.length > 0 ? 
                `<p><strong>Found ${emergencyKeys.length} emergency keys:</strong></p><pre>${emergencyKeys.join('\n')}</pre>` :
                '<p><strong>‚úÖ No emergency keys found</strong></p>';
        }

        function nuclearReset() {
            addResult('‚ò¢Ô∏è Nuclear Reset Started', '<p>Clearing ALL storage keys related to emergency, disable, utc, circuit-breaker...</p>', 'warning');

            let cleared = 0;

            // Clear localStorage
            const lsKeys = Object.keys(localStorage);
            lsKeys.forEach(key => {
                if (key.includes('emergency') || key.includes('disable') || key.includes('utc') || key.includes('circuit')) {
                    console.log('Clearing localStorage:', key, '=', localStorage.getItem(key));
                    localStorage.removeItem(key);
                    cleared++;
                }
            });

            // Clear sessionStorage
            const ssKeys = Object.keys(sessionStorage);
            ssKeys.forEach(key => {
                if (key.includes('emergency') || key.includes('disable') || key.includes('utc') || key.includes('circuit')) {
                    console.log('Clearing sessionStorage:', key, '=', sessionStorage.getItem(key));
                    sessionStorage.removeItem(key);
                    cleared++;
                }
            });

            // Force set UTC flags to enabled
            const utcFlags = {
                "utcDataStorage": true,
                "utcDashboard": true,
                "utcTimerIntegration": true,
                "utcExtensionSync": true,
                "utcMigrationTools": true,
                "utcCalendarSync": true,
                "transitionMode": "dual",
                "rolloutPercentage": 100
            };
            localStorage.setItem('utc-feature-flags', JSON.stringify(utcFlags));

            addResult('‚úÖ Nuclear Reset Complete', 
                `<p>Cleared ${cleared} keys and force-enabled UTC flags.</p>
                 <p><strong>Next:</strong> Refresh localhost:3004 and test session creation.</p>
                 <p><strong>Expected:</strong> isEmergencyDisabled should now be false</p>`, 
                'success');

            setTimeout(updateStatus, 500);
        }

        function deepScan() {
            addResult('üîç Deep Storage Scan', '', 'info');

            const allKeys = {
                localStorage: Object.keys(localStorage),
                sessionStorage: Object.keys(sessionStorage)
            };

            let scanResults = '<h5>All Storage Keys:</h5>';
            
            ['localStorage', 'sessionStorage'].forEach(storageType => {
                scanResults += `<h6>${storageType}:</h6><ul>`;
                allKeys[storageType].forEach(key => {
                    const value = window[storageType].getItem(key);
                    const isEmergency = key.includes('emergency') || key.includes('disable') || key.includes('circuit');
                    scanResults += `<li${isEmergency ? ' style="color: red; font-weight: bold;"' : ''}>${key} = ${value}</li>`;
                });
                scanResults += '</ul>';
            });

            addResult('üîç Storage Scan Results', scanResults, 'info');
        }

        function verifyFix() {
            const emergencyDisable = localStorage.getItem('utc-emergency-disable');
            const isBlocked = emergencyDisable === 'true';

            if (isBlocked) {
                addResult('‚ùå Fix NOT Working', 
                    `<p>Emergency disable is still: <code>${emergencyDisable}</code></p>
                     <p>UTC sessions will continue to be blocked.</p>
                     <p><strong>Action needed:</strong> Run Nuclear Reset</p>`, 
                    'urgent');
            } else {
                addResult('‚úÖ Fix Verified', 
                    `<p>Emergency disable is: <code>${emergencyDisable}</code></p>
                     <p>UTC sessions should now work properly!</p>
                     <p><strong>Test:</strong> Go to localhost:3004 and create a session</p>`, 
                    'success');
            }

            setTimeout(updateStatus, 500);
        }

        function copyCommands() {
            const commands = document.getElementById('console-commands').textContent;
            navigator.clipboard.writeText(commands).then(() => {
                alert('Commands copied! Paste in localhost:3004 console.');
            }).catch(() => {
                alert('Copy failed. Please manually copy the commands.');
            });
        }

        // Initialize
        setTimeout(() => {
            updateStatus();
            verifyFix();
        }, 500);

        // Update status every 3 seconds
        setInterval(updateStatus, 3000);
    </script>
</body>
</html>