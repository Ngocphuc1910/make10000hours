<!DOCTYPE html>
<html>
<head>
    <title>Debug Timezone Settings</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 5px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        button { background: #374151; color: white; border: 1px solid #4b5563; padding: 8px 16px; margin: 5px; cursor: pointer; }
        button:hover { background: #4b5563; }
        input, select { background: #374151; color: white; border: 1px solid #4b5563; padding: 5px; margin: 5px; }
    </style>
</head>
<body>
    <h1>üïê Timezone Debug Tool</h1>
    
    <div class="section">
        <h2>üîç Current Settings Analysis</h2>
        <button onclick="analyzeTimezoneSettings()">Analyze Current Settings</button>
        <div id="settings-analysis"></div>
    </div>
    
    <div class="section">
        <h2>üåç Browser vs User Settings</h2>
        <button onclick="compareTimezones()">Compare Timezones</button>
        <div id="timezone-comparison"></div>
    </div>
    
    <div class="section">
        <h2>üß™ Test Timezone Conversion</h2>
        <input type="text" id="test-timezone" placeholder="Enter timezone (e.g., Asia/Ho_Chi_Minh)" value="Asia/Ho_Chi_Minh">
        <button onclick="testTimezoneConversion()">Test Conversion</button>
        <div id="conversion-test"></div>
    </div>
    
    <div class="section">
        <h2>üîß Fix Tools</h2>
        <select id="timezone-selector">
            <option value="">-- Select Timezone --</option>
            <option value="America/Los_Angeles">Los Angeles (PST/PDT)</option>
            <option value="Asia/Ho_Chi_Minh">Vietnam (ICT)</option>
            <option value="Asia/Shanghai">Shanghai (CST)</option>
            <option value="Europe/London">London (GMT/BST)</option>
            <option value="America/New_York">New York (EST/EDT)</option>
        </select>
        <button onclick="updateUserTimezone()">Update User Timezone</button>
        <div id="update-result"></div>
    </div>
    
    <script>
        // Analysis Functions
        function analyzeTimezoneSettings() {
            const results = document.getElementById('settings-analysis');
            results.innerHTML = '<p>Analyzing...</p>';
            
            try {
                // Get user from store
                const user = window.useUserStore?.getState()?.user;
                
                const analysis = {
                    userExists: !!user,
                    userSettings: user?.settings,
                    timezoneSettings: user?.settings?.timezone,
                    currentTimezone: user?.settings?.timezone?.current,
                    browserTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    timezoneUtilsCurrent: window.timezoneUtils?.getCurrentTimezone()
                };
                
                let html = '<h3>Analysis Results:</h3>';
                html += `<p class="${analysis.userExists ? 'success' : 'error'}">User exists: ${analysis.userExists}</p>`;
                
                if (analysis.userExists) {
                    html += `<p class="info">User settings structure:</p>`;
                    html += `<pre>${JSON.stringify(analysis.userSettings, null, 2)}</pre>`;
                    
                    html += `<p class="info">Timezone settings:</p>`;
                    html += `<pre>${JSON.stringify(analysis.timezoneSettings, null, 2)}</pre>`;
                    
                    html += `<p class="${analysis.currentTimezone ? 'success' : 'warning'}">Current timezone: ${analysis.currentTimezone || 'NOT SET'}</p>`;
                }
                
                html += `<p class="info">Browser timezone: ${analysis.browserTimezone}</p>`;
                html += `<p class="info">TimezoneUtils current: ${analysis.timezoneUtilsCurrent}</p>`;
                
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                console.error('Analysis error:', error);
            }
        }
        
        function compareTimezones() {
            const results = document.getElementById('timezone-comparison');
            results.innerHTML = '<p>Comparing...</p>';
            
            try {
                const user = window.useUserStore?.getState()?.user;
                const userTimezone = user?.settings?.timezone?.current;
                const browserTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const utilsTimezone = window.timezoneUtils?.getCurrentTimezone();
                
                let html = '<h3>Timezone Comparison:</h3>';
                html += `<p><strong>User Setting:</strong> <span class="${userTimezone ? 'success' : 'error'}">${userTimezone || 'NOT SET'}</span></p>`;
                html += `<p><strong>Browser Detected:</strong> <span class="info">${browserTimezone}</span></p>`;
                html += `<p><strong>Utils Current:</strong> <span class="info">${utilsTimezone}</span></p>`;
                
                const match = userTimezone === browserTimezone;
                html += `<p><strong>Match:</strong> <span class="${match ? 'success' : 'warning'}">${match ? 'YES' : 'NO'}</span></p>`;
                
                if (!match && userTimezone) {
                    html += `<p class="warning">‚ö†Ô∏è User timezone setting doesn't match browser timezone!</p>`;
                }
                
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                console.error('Comparison error:', error);
            }
        }
        
        function testTimezoneConversion() {
            const timezone = document.getElementById('test-timezone').value;
            const results = document.getElementById('conversion-test');
            
            if (!timezone) {
                results.innerHTML = '<p class="error">Please enter a timezone</p>';
                return;
            }
            
            results.innerHTML = '<p>Testing...</p>';
            
            try {
                // Test timezone validity
                const isValid = window.timezoneUtils?.isValidTimezone(timezone);
                
                let html = `<h3>Testing: ${timezone}</h3>`;
                html += `<p><strong>Valid:</strong> <span class="${isValid ? 'success' : 'error'}">${isValid ? 'YES' : 'NO'}</span></p>`;
                
                if (isValid) {
                    // Test conversion
                    const testUTC = '2025-08-05T02:00:00.000Z';
                    const converted = window.timezoneUtils?.utcToUserTime(testUTC, timezone);
                    
                    html += `<p><strong>Test UTC:</strong> ${testUTC}</p>`;
                    html += `<p><strong>Converted:</strong> ${converted?.toISOString()}</p>`;
                    html += `<p><strong>Local String:</strong> ${converted?.toLocaleString()}</p>`;
                    
                    // Test task conversion
                    if (window.TaskDisplayService) {
                        const testTask = {
                            id: 'test',
                            title: 'Test Task',
                            scheduledTimeUTC: testUTC,
                            scheduledEndTimeUTC: '2025-08-05T03:00:00.000Z'
                        };
                        
                        const displayTask = window.TaskDisplayService.convertForDisplay(testTask, timezone);
                        html += `<p><strong>Display Time:</strong> ${displayTask.displayScheduledTime} - ${displayTask.displayScheduledEndTime}</p>`;
                        html += `<p><strong>Display Date:</strong> ${displayTask.displayScheduledDate}</p>`;
                    }
                }
                
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `<p class="error">Conversion Error: ${error.message}</p>`;
                console.error('Conversion test error:', error);
            }
        }
        
        async function updateUserTimezone() {
            const timezone = document.getElementById('timezone-selector').value;
            const results = document.getElementById('update-result');
            
            if (!timezone) {
                results.innerHTML = '<p class="error">Please select a timezone</p>';
                return;
            }
            
            results.innerHTML = '<p>Updating...</p>';
            
            try {
                const userStore = window.useUserStore?.getState();
                if (!userStore || !userStore.updateTimezone) {
                    throw new Error('User store or updateTimezone method not available');
                }
                
                await userStore.updateTimezone(timezone);
                
                results.innerHTML = `<p class="success">‚úÖ Timezone updated to: ${timezone}</p>`;
                
                // Refresh analysis
                setTimeout(() => {
                    analyzeTimezoneSettings();
                    compareTimezones();
                }, 500);
                
            } catch (error) {
                results.innerHTML = `<p class="error">Update Error: ${error.message}</p>`;
                console.error('Update error:', error);
            }
        }
        
        // Auto-run analysis on load
        setTimeout(() => {
            if (window.useUserStore && window.timezoneUtils) {
                analyzeTimezoneSettings();
                compareTimezones();
            } else {
                document.getElementById('settings-analysis').innerHTML = '<p class="error">Required services not loaded yet. Try refreshing the page.</p>';
            }
        }, 1000);
    </script>
</body>
</html>