<!DOCTYPE html>
<html>
<head>
    <title>Debug Calendar Data Flow</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .debug-section { margin: 20px 0; padding: 15px; background: #2a2a2a; border-radius: 5px; }
        .debug-title { color: #4CAF50; font-weight: bold; margin-bottom: 10px; }
        pre { background: #333; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .success { color: #4CAF50; }
        .info { color: #2196F3; }
        button { 
            background: #4CAF50; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background: #45a049; }
    </style>
</head>
<body>
    <h1>üîç Calendar Data Flow Debug</h1>
    
    <div class="debug-section">
        <div class="debug-title">Instructions</div>
        <p>1. Navigate to localhost:3001/calendar in another tab</p>
        <p>2. Come back to this tab</p>
        <p>3. Click the debug buttons below</p>
        <button onclick="runFullDiagnostic()">üîç Run Full Diagnostic</button>
        <button onclick="enableDebugMode()">üêõ Enable Debug Mode</button>
        <button onclick="testMergeFunction()">üîÑ Test Merge Function</button>
    </div>

    <div class="debug-section" id="output">
        <div class="debug-title">Debug Output</div>
        <pre id="debug-output">Waiting for diagnostic...</pre>
    </div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('debug-output');
            const className = type;
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            console.log(message);
        }

        function clearOutput() {
            document.getElementById('debug-output').innerHTML = '';
        }

        function enableDebugMode() {
            clearOutput();
            log('üêõ Enabling calendar debug mode...', 'info');
            
            // Enable debug mode
            globalThis.__debug_calendar_conversion = true;
            log('‚úÖ Debug mode enabled', 'success');
            
            // Force a re-render by touching task store
            setTimeout(() => {
                try {
                    const taskStore = window.useTaskStore?.getState?.();
                    if (taskStore && taskStore.tasks?.length > 0) {
                        const firstTask = taskStore.tasks[0];
                        log('üìù Triggering calendar re-render...', 'info');
                        
                        // Touch the first task to trigger re-render
                        taskStore.updateTask?.(firstTask.id, {
                            updatedAt: new Date().toISOString()
                        });
                        
                        log('‚úÖ Re-render triggered', 'success');
                    } else {
                        log('‚ö†Ô∏è No tasks found to trigger re-render', 'warning');
                    }
                } catch (error) {
                    log('‚ùå Error triggering re-render: ' + error.message, 'error');
                }
            }, 1000);
        }

        function testMergeFunction() {
            clearOutput();
            log('üîÑ Testing merge function logic...', 'info');
            
            try {
                const taskStore = window.useTaskStore?.getState?.();
                if (!taskStore) {
                    log('‚ùå TaskStore not found', 'error');
                    return;
                }

                log('üìä Data available:', 'info');
                log(`  - Tasks: ${taskStore.tasks?.length || 0}`, 'info');
                log(`  - Projects: ${taskStore.projects?.length || 0}`, 'info');

                if (taskStore.tasks?.length > 0) {
                    log('üìù First task sample:', 'info');
                    const firstTask = taskStore.tasks[0];
                    log(`  - ID: ${firstTask.id}`, 'info');
                    log(`  - Title: ${firstTask.title}`, 'info');
                    log(`  - Scheduled Date: ${firstTask.scheduledDate || 'None'}`, 'info');
                    log(`  - Include Time: ${firstTask.includeTime || false}`, 'info');
                }

                // Check timezone
                const userStore = window.useUserStore?.getState?.();
                const userTimezone = userStore?.user?.settings?.timezone?.current;
                log(`üåç User timezone: ${userTimezone || 'Not set'}`, 'info');
                log(`üåç Browser timezone: ${Intl.DateTimeFormat().resolvedOptions().timeZone}`, 'info');

                // Try to access TaskDisplayService
                if (window.TaskDisplayService) {
                    log('‚úÖ TaskDisplayService available', 'success');
                } else {
                    log('‚ùå TaskDisplayService not available', 'error');
                }

            } catch (error) {
                log('‚ùå Error testing merge function: ' + error.message, 'error');
            }
        }

        function runFullDiagnostic() {
            clearOutput();
            log('üîç Starting full calendar diagnostic...', 'info');
            
            // Check if we're in the right environment
            if (typeof window.useTaskStore === 'undefined') {
                log('‚ùå React environment not detected', 'error');
                log('üîÑ Navigate to localhost:3001/calendar first', 'warning');
                return;
            }

            // Enable debug mode first
            globalThis.__debug_calendar_conversion = true;
            log('‚úÖ Debug mode enabled', 'success');

            // Check stores
            try {
                const taskStore = window.useTaskStore?.getState?.();
                const userStore = window.useUserStore?.getState?.();
                const uiStore = window.useUIStore?.getState?.();

                log('üìä STORE STATUS:', 'info');
                log(`  - TaskStore: ${taskStore ? '‚úÖ' : '‚ùå'}`, taskStore ? 'success' : 'error');
                log(`  - UserStore: ${userStore ? '‚úÖ' : '‚ùå'}`, userStore ? 'success' : 'error');
                log(`  - UIStore: ${uiStore ? '‚úÖ' : '‚ùå'}`, uiStore ? 'success' : 'error');

                if (taskStore) {
                    log('üìã TASK DATA:', 'info');
                    log(`  - Tasks: ${taskStore.tasks?.length || 0}`, 'info');
                    log(`  - Projects: ${taskStore.projects?.length || 0}`, 'info');
                    
                    if (taskStore.tasks?.length > 0) {
                        const scheduledTasks = taskStore.tasks.filter(t => t.scheduledDate);
                        log(`  - Scheduled tasks: ${scheduledTasks.length}`, 'info');
                        
                        if (scheduledTasks.length > 0) {
                            log('üìÖ First scheduled task:', 'info');
                            const first = scheduledTasks[0];
                            log(`    - Title: ${first.title}`, 'info');
                            log(`    - Date: ${first.scheduledDate}`, 'info');
                            log(`    - Time: ${first.scheduledStartTime || 'All-day'}`, 'info');
                        }
                    }
                }

                if (userStore) {
                    log('üë§ USER DATA:', 'info');
                    log(`  - Logged in: ${userStore.user ? '‚úÖ' : '‚ùå'}`, userStore.user ? 'success' : 'error');
                    if (userStore.user) {
                        log(`  - Timezone: ${userStore.user.settings?.timezone?.current || 'Not set'}`, 'info');
                    }
                }

                if (uiStore) {
                    log('üéõÔ∏è UI SETTINGS:', 'info');
                    log(`  - Feature flags: ${JSON.stringify(uiStore.featureFlags || {})}`, 'info');
                }

                // Test calendar computation manually
                log('üîÑ MANUAL CALENDAR TEST:', 'info');
                
                if (taskStore?.tasks && window.TaskDisplayService) {
                    try {
                        const userTimezone = userStore?.user?.settings?.timezone?.current || 
                                           Intl.DateTimeFormat().resolvedOptions().timeZone;
                        
                        log(`  - Converting ${taskStore.tasks.length} tasks with timezone: ${userTimezone}`, 'info');
                        
                        const displayTasks = window.TaskDisplayService.batchConvertForDisplay(taskStore.tasks, userTimezone);
                        log(`  - Converted to ${displayTasks.length} display tasks`, displayTasks.length > 0 ? 'success' : 'warning');
                        
                        // Check if we can access merge function (probably not, but worth trying)
                        log('  - mergeEventsAndTasks function not accessible from window', 'warning');
                        log('  - This is expected - function is scoped to Calendar component', 'info');
                        
                    } catch (error) {
                        log(`  - ‚ùå Error in manual conversion: ${error.message}`, 'error');
                    }
                } else {
                    log('  - ‚ùå Cannot perform manual test - missing dependencies', 'error');
                }

                // Summary
                log('üìã DIAGNOSTIC SUMMARY:', 'info');
                const hasData = taskStore?.tasks?.length > 0;
                const hasScheduled = taskStore?.tasks?.some(t => t.scheduledDate);
                const hasServices = !!window.TaskDisplayService;
                
                log(`  - Has task data: ${hasData ? '‚úÖ' : '‚ùå'}`, hasData ? 'success' : 'error');
                log(`  - Has scheduled tasks: ${hasScheduled ? '‚úÖ' : '‚ùå'}`, hasScheduled ? 'success' : 'error');
                log(`  - Has services: ${hasServices ? '‚úÖ' : '‚ùå'}`, hasServices ? 'success' : 'error');
                
                if (hasData && hasScheduled && hasServices) {
                    log('‚úÖ All systems operational - calendar should show data', 'success');
                    log('üîç If calendar is still empty, the issue is in the Calendar component rendering', 'warning');
                } else {
                    log('‚ùå Critical systems missing - calendar will be empty', 'error');
                }

            } catch (error) {
                log('‚ùå Diagnostic failed: ' + error.message, 'error');
            }
        }

        // Auto-run diagnostic after 2 seconds
        setTimeout(() => {
            log('‚è∞ Auto-running diagnostic in 2 seconds...', 'info');
            setTimeout(runFullDiagnostic, 2000);
        }, 100);
    </script>
</body>
</html>